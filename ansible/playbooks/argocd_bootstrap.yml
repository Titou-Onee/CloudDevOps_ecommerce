# Main playbook
# Prepare cluster
# Install Argocd and apps
- name: configuration of variables
  hosts: localhost
  connection: localhost

  vars_prompt:
    - name: "ebs_csi_role_arn_input"
      prompt: "Enter the ARN of the IAM (ebs_csi_role_arn)"
      default: ""
      private: false

  tasks:
    - name: Fixer la variable pour tout le cycle de vie
      set_fact:
        ebs_csi_role_arn: "{{ ebs_csi_role_arn_input }}"
        
- name: Deploy Argocd and apps
  hosts: kubernetes
  gather_facts: false
 
  pre_tasks:
    - name: cluster preparation
      include_role:
        name: prepare-cluster
      tags: [configuration]

  tasks:
    - name: Install argocd
      include_role:
        name: argocd
      tags: [argocd]
  
  post_tasks:
    - name: Vérifier les applications ArgoCD créées
      kubernetes.core.k8s_info:
        api_version: argoproj.io/v1alpha1
        kind: Application
        namespace: "{{ argocd.namespace }}"
        kubeconfig: "{{ kubeconfig_path }}"
      register: argocd_apps
    
