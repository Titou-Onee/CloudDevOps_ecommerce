# Main roles
# Install ArgoCD (namespaces, redis, argo serveur)
# Install the app-of-apps through argocd
- name: Add ArgoCD Helm Repository
  kubernetes.core.helm_repository:
    name: argocd
    repo_url: https://argoproj.github.io/argo-helm
    state: present

- name: Create ArgoCD and monitoring namespace
  kubernetes.core.k8s:
    name: "{{ item }}"
    api_version: v1
    kind: namespace
    state: present
    kubeconfig: "{{ kubeconfig_path }}"
  loop:
    - "{{ argocd.namespace }}"
    - "{{ applications.monitoring.prometheus.namespace }}"


# In the context of this project, we accept to use an insecure way to define password
- name: Create Redis secret
  kubernetes.core.k8s:
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: argocd-redis
        namespace: "{{ argocd.namespace }}"
      type: Opaque
      stringData:
          auth: "unsecure_admin_password"
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    
- name: Install ArgoCD with Helm
  kubernetes.core.helm:
    name: argocd
    chart_ref: argocd/argo-cd
    release_namespace: "{{ argocd.namespace }}"
    create_namespace: false
    kubeconfig: "{{ kubeconfig_path }}"
    wait: true
    wait_timeout: 400s
    values:
      global:
        image:
          tag: "{{ argocd.version }}"
        podSecurityContext:
          runAsNonRoot: true
          runAsUser: 999
          fsGroup: 999
      config:
        secret:
          argocd_serv_admin_pass: "{{ argocd.admin_password[:72] | password_hash('sha512_crypt') }}"

      controller:
        containerSecurityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          capabilities:
            drop: ["ALL"]
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: "{{ applications.monitoring.prometheus.namespace }}"
      server:
        containerSecurityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: "{{ applications.monitoring.prometheus.namespace }}"
                       
      repoServer:
        containerSecurityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
        metrics:
          enabled: true
          serviceMonitor:
            enabled: true
            namespace: "{{ applications.monitoring.prometheus.namespace }}"
      
      redis:
        podSecurityContext:
          runAsNonRoot: true
          runAsUser: 999
        containerSecurityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
      cm:
        application.instanceLabelKey: argocd.argoproj.io/instance 
        exec.enabled: "true"

- name: Creation of ArgoCD projects
  ansible.builtin.include_role:
    name: prepare-argocd-projects

- name: Creation of repositories secrets
  kubernetes.core.k8s:
    definition:
      api_version: v1
      kind: Secret
      metadata:
        name: "{{ item.name }}-repo"
        namespace: "{{ argocd.namespace }}"
        labels:
          argocd.argoproj.io/secret-type: repository
      stringData:
        type: git
        url: "{{ item.url }}"
        name: "{{ item.name }}"
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
  loop: "{{ argocd.repositories }}"
  when: argocd.repositories is defined

- name: Wait for ArgoCD Serv
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: argocd-server
    namespace: "{{ argocd.namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
    wait: true
    wait_condition:
      type: Available
      status: true
    wait_timeout: 600
  
- name: Create Bootstrap application (App of Apps)
  kubernetes.core.k8s:
    definition:
      apiVersion: argoproj.io/v1alpha1
      kind: Application
      metadata:
        name: "{{ argocd.bootstrap.name }}"
        namespace: "{{ argocd.namespace }}"
        finalizers:
          - resources-finalizer.argocd.argoproj.io
      spec:
        project: system-project
        source:
          repoURL: "{{ argocd.git_repo.url }}"
          targetRevision: HEAD
          path: "{{ argocd.bootstrap.path }}"
        destination:
          server: https://kubernetes.default.svc
          namespace: "{{ argocd.namespace }}"
        syncPolicy:
          automated:
            prune: "{{ argocd.bootstrap.auto_sync }}"
            selfHeal: "{{ argocd.bootstrap.self_heal }}"
            allowEmpty: false
          syncOptions:
            - CreateNamespace=true
          retry:
            limit: 5
            backoff:
              duration: 5s
              factor: 2
              maxDuration: 3m
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
  when: argocd.bootstrap.enabled

- name: Wait for bootstrap application
  kubernetes.core.k8s_info:
    api_version: argoproj.io/v1alpha1
    kind: Application
    name: "{{ argocd.bootstrap.name }}"
    namespace: "{{ argocd.namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
    wait: true
    wait_timeout: 60
  when: argocd.bootstrap.enabled