# Verify the cluster state
# Install CSI EBS drivers and ensure that gp3 storageclass exists
- name: Vérifier la connexion au cluster
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ kubeconfig_path }}"
  register: nodes_info

- name: Vérifier si le driver CSI EBS est déjà installé
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: CSIDriver
    name: ebs.csi.aws.com
    kubeconfig: "{{ kubeconfig_path }}"
  register: csi_driver_check
  failed_when: false

- name: Ajouter le dépôt Helm du driver EBS CSI
  kubernetes.core.helm_repository:
    name: aws-ebs-csi-driver
    repo_url: https://kubernetes-sigs.github.io/aws-ebs-csi-driver
    state: present
  when: csi_driver_check.resources | length == 0

- name: Installer/Mettre à jour le driver EBS CSI
  kubernetes.core.helm:
    name: aws-ebs-csi-driver
    chart_ref: aws-ebs-csi-driver/aws-ebs-csi-driver
    release_namespace: kube-system
    kubeconfig: "{{ kubeconfig_path }}"
    wait: true
    wait_timeout: "{{ helm_timeout | default('5m') }}"
    values:
      controller:
        serviceAccount:
          create: true
          name: ebs-csi-controller-sa
          annotations:
            eks.amazonaws.com/role-arn: "{{ ebs_csi_role_arn }}"
        region: "{{ aws_region | default(omit) }}"
      node:
        serviceAccount:
          create: true
          name: ebs-csi-node-sa      
  when: csi_driver_check.resources | length == 0

- name: Attendre que le driver CSI soit prêt
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: ebs-csi-controller
    namespace: kube-system
    kubeconfig: "{{ kubeconfig_path }}"
  register: csi_controller
  until: 
    - csi_controller.resources | length > 0
    - csi_controller.resources[0].status.readyReplicas | default(0) > 0
  retries: 30
  delay: 10
  when: csi_driver_check.resources | length == 0


- name: Lister les StorageClass existantes
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    kubeconfig: "{{ kubeconfig_path }}"
  register: storage_classes

- name: Créer la StorageClass gp3
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: storage.k8s.io/v1
      kind: StorageClass
      metadata:
        name: gp3
        annotations:
          storageclass.kubernetes.io/is-default-class: "{{ set_gp3_default | default('false') | string }}"
      provisioner: ebs.csi.aws.com
      volumeBindingMode: WaitForFirstConsumer
      allowVolumeExpansion: true
      reclaimPolicy: Delete
      parameters:
        type: gp3
        encrypted: "true"
        iops: "{{ gp3_iops | default('3000') | string}}"
        throughput: "{{ gp3_throughput | default('125') | string}}"
  when: "'gp3' not in (storage_classes.resources | map(attribute='metadata.name') | list)"

- name: Vérifier l'état final du cluster
  kubernetes.core.k8s_info:
    api_version: v1
    kind: Node
    kubeconfig: "{{ kubeconfig_path }}"
  register: final_nodes

- name: Vérifier les StorageClass disponibles
  kubernetes.core.k8s_info:
    api_version: storage.k8s.io/v1
    kind: StorageClass
    kubeconfig: "{{ kubeconfig_path }}"
  register: final_storage_classes

- name: Afficher le résumé de l'installation
  debug:
    msg:
      - "=== Résumé de l'installation ==="
      - "Cluster: {{ kubernetes.cluster_name }}"
      - "Nœuds: {{ final_nodes.resources | length }}"
      - "Rôle IAM: {{ ebs_csi_role_arn }}"
      - "Driver CSI EBS: {{ 'Installé' if csi_driver_check.resources | length == 0 else 'Déjà présent' }}"
      - "StorageClasses disponibles: {{ final_storage_classes.resources | map(attribute='metadata.name') | list | join(', ') }}"